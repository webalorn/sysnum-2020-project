# ASMV

This assembly can be seen as a simplified version of the (risc-V assembly)[https://github.com/riscv/riscv-asm-manual/blob/master/riscv-asm.md]. More specifically, it is sufficient to assemble all the assembly code generated by clang for this project, but it doesn't include any unused extensions.

## Command usage

## ASM description

Each line can start with a label. A label is a string followed by a `:`, like this: `labelname:`. The valid characters for a label are `[0-9a-zA-Z_]`. It will be converted to the memory address of the next instruction or data block location. If a label is not followed by any instruction, it will point to the next free memory byte, just after the program.

Comments start with `#` or `//` and end at the end of the line.

There is two type of instructions:

### Configuration instruction

A configuration instruction starts with a `.` followed, without space, by the name of the instruction. One configuration instruction is valid only for the instruction after it (if applicable).

```
#align n
#start labelname
```

- `.align`: `n` must be an integer. It aligns each data block on `n` bytes. The default value is `1`. With `4`, a single char will use `32` bits, but a string of 4 chars still uses `32` bits. Must be `1`, `2` or `4`.
- `.start` set the starting label. Default is `main`

### Data block

A datablock is of the following form : `.typename value`. It is strongly advised to put the datablocks at the end of the program, because it could disrupt the program flow if they are not 4-byte aligned, or the program doesn't explicitly jump over them. The allowed types are:

```
.int [32_bits_signed_int]
.uint [32_bits_signed_int]
.string "sequence_of_chars"
```


### Data formats

- **integers** (operand and data)
  - `42`, `-42` : decimal
  - `0b101010`, `-0b101010` : binary
  - `0x2a`, `-0x2a` : hexadecimal
  - `*label` : address of the memory pointer associated with `label`
  - `label` : relative address of the memory pointer associated with `label`
- **string** (data)
  - "this_is_a_string" : must be surrounded by `"`.
- **register**
  - `x0`, ..., `x31`

### Assembly instructions

An assembly instruction generates one (or multiple for some pseudo-instructions) instructions for the ISA.

#### Base integer instructions

- Integer Register-Immediate Instructions
  - `ADDI rd rs1 int:12` : rd <- rs1 + int:12
  - `SLTI rd rs1 int:12` : rd <- 1 if rs1 < int:12 else 0
  - `SLTIU rd rs1 uint:12` : rd <- 1 if rs1 < **uint:12** else 0
  - `ANDI rd rs1 int:12`
  - `ORI rd rs1 int:12`
  - `XORI rd rs1 int:12`
  - Shifts
    - `SLLI rd rs1 int:4` : shift left
    - `SRLI rd rs1 int:4` : shift right
    - `SRAI rd rs1 int:4` : shift left but keep sign
  - Load (20 bits operand, fill the lowest 12 bits with 0)
    - `LUI rd int:20` : rd <- int . 000000000000
    - `AUIPC rd int:20` : rd <- pc + (int . 000000000000)
- ...

- Pseudo-instructions
  - `NOT rd rs` : rd <- ~(rs)  => `XORI rs rs1 -1`
  - `MV rd rs` : rd <- rs  => `ADDI rd rs 0`
  - `LI rd uint:32` : rd <- uint
  - ...
